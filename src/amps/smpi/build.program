#BHEADER***********************************************************************
# (c) 1995   The Regents of the University of California
#
# See the file COPYRIGHT_and_DISCLAIMER for a complete copyright
# notice, contact person, and disclaimer.
#
# $Revision: 1.1.1.1 $
#EHEADER***********************************************************************

#=============================================================================
#
# Set up directory locations
#
#=============================================================================
if [ -z "$PARFLOW_SRC" ]
then
        PARFLOW_SRC=$PARFLOW_DIR
fi

PARFLOW_LIB=$PARFLOW_SRC/lib
if [ ! -d $PARFLOW_LIB ]
then
        mkdir $PARFLOW_LIB
fi

#=============================================================================
#
# Determine the arch that we are compiling on
#
#=============================================================================
. $PARFLOW_SRC/config/getarch

PF_NODE_EXT=smpi.$PF_ARCH
export PF_NODE_EXT

#=============================================================================
#
# If on a new arch then clean everything
#
#=============================================================================
if [ "$PF_ARCH" != "$PF_OLD_ARCH" ]
then
	(cd $PARFLOW_SRC/parflow/; rm -f $PF_PROGRAM)
fi

#=============================================================================
#
# Set up directory locations
#
#=============================================================================
if [ -z "$PARFLOW_SRC" ]
then
        PARFLOW_SRC=$PARFLOW_DIR
fi

#=============================================================================
#
# Do the actual make 
#
#=============================================================================
if [ "$PF_ALL_FLAG" ]
then
	(cd $PARFLOW_SRC/amps/$PF_COMM/
	./build
	cd $PARFLOW_SRC/kinsol
	./build
	cd $PARFLOW_SRC/parflow
	$PF_MAKE ${PF_PROGRAM}.${PF_NODE_EXT}
	)

fi


#=============================================================================
#
# Do the install
# 
#=============================================================================
if [ "$PF_INSTALL_FLAG" ] 
then
	rm -f $PARFLOW_BIN/$PF_PROGRAM
	$PF_INSTALL $PARFLOW_SRC/parflow/$PF_PROGRAM.$PF_NODE_EXT $PARFLOW_BIN/$PF_PROGRAM

	rm -f $PARFLOW_BIN/$PF_PROGRAM.$PF_NODE_EXT
	$PF_INSTALL $PARFLOW_SRC/parflow/$PF_PROGRAM.$PF_NODE_EXT $PARFLOW_BIN/$PF_PROGRAM.$PF_NODE_EXT

	(cd $PARFLOW_BIN
	SCRIPTS="bootmc getmc run freemc killmc peekmc clean batchmc"
	for i in $SCRIPTS
	do
	    rm -f $i
	    $PF_INSTALL $PARFLOW_SRC/amps/$PF_COMM/$i $i
	done
	)

fi

#=============================================================================
#
# Clean the local directory
#
#=============================================================================
if [ "$PF_CLEAN_FLAG" ]
then
	(cd $PARFLOW_SRC/parflow/; rm -f *$PF_NODE_EXT.o)
	(cd $PARFLOW_SRC/amps/$PF_COMM; rm -f *$PF_NODE_EXT.o)
	(cd $PARFLOW_SRC/amps/common; rm -f *$PF_NODE_EXT.o)
	(cd $PARFLOW_SRC/kinsol; rm -f *$PF_NODE_EXT.o)
fi

if [ "$PF_VERYCLEAN_FLAG" ]
then
	(cd $PARFLOW_SRC/parflow/; rm -f $PF_PROGRAM$PF_NODE_EXT *$PF_NODE_EXT.a)
	(cd $PARFLOW_SRC/amps/$PF_COMM; rm -f *$PF_NODE_EXT.a)
	(cd $PARFLOW_SRC/amps/common; rm -f *$PF_NODE_EXT.o)
	(cd $PARFLOW_SRC/kinsol; rm -f *$PF_NODE_EXT.a)
	(cd $PARFLOW_LIB; rm -f *$PF_NODE_EXT.a)

fi

